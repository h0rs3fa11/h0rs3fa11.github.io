
<!DOCTYPE html>
<html lang="">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="H0rs3fa11&#39;s blog">
    <title>H0rs3fa11&#39;s blog</title>
    <meta name="author" content="h0rs3fa11">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"Website","@id":"https://h0rs3fa11.github.io","author":{"@type":"Person","name":"h0rs3fa11","sameAs":["https://github.com/h0rs3fa11"]},"name":"H0rs3fa11's blog","description":"光暗布满征途，绝处可寻答案","url":"https://h0rs3fa11.github.io"}</script>
    <meta name="description" content="光暗布满征途，绝处可寻答案">
<meta property="og:type" content="blog">
<meta property="og:title" content="H0rs3fa11&#39;s blog">
<meta property="og:url" content="https://h0rs3fa11.github.io/index.html">
<meta property="og:site_name" content="H0rs3fa11&#39;s blog">
<meta property="og:description" content="光暗布满征途，绝处可寻答案">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="H0rs3fa11&#39;s blog">
<meta name="twitter:description" content="光暗布满征途，绝处可寻答案">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-lenymrut8wwix6t2rtc30tapqoi11l3hm7kl7o9qxgucelaaelnvhj8vtktq.min.css">
    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/" aria-label="">
            H0rs3fa11&#39;s blog
        </a>
    </div>
    
        
            <a class="header-right-picture " href="#about" aria-label="Abre el enlace: /#about">
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/" rel="noopener" title="Inicio">
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Inicio</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" rel="noopener" title="Categorías">
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categorías</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" rel="noopener" title="Archivos">
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archivos</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="#search" rel="noopener" title="Buscar">
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Buscar</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/about" rel="noopener" title="Acerca de">
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Acerca de</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/h0rs3fa11" target="_blank" rel="noopener" title="GitHub">
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/12/13/hyperledgerfabric-ledger-security/" aria-label=": Hyperledger Fabric世界状态的篡改">
                            Hyperledger Fabric世界状态的篡改
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-12-13T15:55:53+08:00">
	
		    13 Dec 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>Fabric的账本数据存储分为不可变的历史数据存储，也就是区块链形式，以文件形式保存；另外是可变的世界状态，用nosql存储当前状态的key-value，fabric支持的世界状态存储数据库有LevelDB和CouchDB。</p>
<p>实验使用fabric first-network测试环境</p>
<p>本文所有查询与调用合约都使用的SDK</p>
<h3 id="0x02-测试：修改世界状态"><a href="#0x02-测试：修改世界状态" class="headerlink" title="0x02 测试：修改世界状态"></a>0x02 测试：修改世界状态</h3><p>测试所用链码：fabcar</p>
<p>代码位置：<a href="https://github.com/hyperledger/fabric-samples/blob/release/chaincode/fabcar/fabcar.go" target="_blank" rel="noopener">https://github.com/hyperledger/fabric-samples/blob/release/chaincode/fabcar/fabcar.go</a></p>
<p>测试链码的背书策略都是1-of Org1MSP，即满足Org1的任意节点背书即可</p>
<p>修改账本节点：peer0.org1.example.com</p>
<p>leveldb路径为Mountpoint下的ledgersData/stateLeveldb/，然后通过leveldb数据库查询账本数据(leveldb提供了API)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CAR0 &#123;&quot;make&quot;:&quot;Toyota&quot;,&quot;model&quot;:&quot;Prius&quot;,&quot;colour&quot;:&quot;blue&quot;,&quot;owner&quot;:&quot;Tomoko&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>更改CAR0的colour为yellow，更改leveldb数据库时需要关闭当前节点，完毕后再启动<br><img src="/image/fabric01.PNG" alt="图片"></p>
<p>用API调用链码fabcar的queryCar函数查询peer0的CAR0信息</p>
<p><img src="/image/fabric02.PNG" alt="图片"></p>
<p>查询未篡改节点的CAR0信息</p>
<p><img src="/image/fabric03.PNG" alt="图片"></p>
<p>在peer0上调用fabcar的changeCarOwner函数，接着查询peer0的CAR0，owner已经修改</p>
<p><img src="/image/fabric04.PNG" alt="图片"></p>
<p>再查询peer1的CAR0，可以看到在随着owner更改的同时，colour变为了peer0的篡改数据</p>
<p><img src="/image/fabric05.png" alt="图片"></p>
<p>使用一个复杂一点的链码，实现了简单的注册、充值和转账</p>
<p>注册一个新用户test1，初始余额为0</p>
<p><img src="/image/fabric06.png" alt="图片"></p>
<p>修改peer0的leveldb账本，使得test1的Amount为10</p>
<p><img src="/image/fabric07.png" alt="图片"></p>
<p>调用链码函数查询peer1的test1余额!</p>
<p><a href="/image/fabric08.png">图片</a></p>
<p>接下来测试被篡改节点peer0发起的交易能否修改其他账本的数据</p>
<p>调用链码paycode函数recharge给账号test1充值20，然后查询各个节点的test1余额；peer0节点毫无悬念的是篡改后的值+20=30，通过查询可以看到peer1节点也是这个值</p>
<p><img src="/image/fabric09.png" alt="图片"></p>
<p>通过以上测试可以发现，在节点的世界状态被篡改并且背书策略只设置为少量节点背书的话，可以很轻易的修改正常节点的账本。这涉及到Fabric中背书-验证的机制。</p>
<h3 id="0x03-交易流程"><a href="#0x03-交易流程" class="headerlink" title="0x03 交易流程"></a>0x03 交易流程</h3><p>当客户端要调用链码testcode，需要向多少个节点请求取决于链码的背书策略，在安装-实例化链码的实例化时指定（在2.x中，链码生命周期有所修改，链码的背书策略需要组织认可）。示例背书策略如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">policy = &#123;</span><br><span class="line">    &apos;identities&apos;: [</span><br><span class="line">        &#123;&apos;role&apos;: &#123;&apos;name&apos;: &apos;member&apos;, &apos;mspId&apos;: &apos;Org1MSP&apos;&#125;&#125;,</span><br><span class="line">    ],</span><br><span class="line">    &apos;policy&apos;: &#123;</span><br><span class="line">        &apos;1-of&apos;: [</span><br><span class="line">            &#123;&apos;signed-by&apos;: 0&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该背书策略仅需要Org1MSP成员的背书<br>接下来客户端需要向peer0.org1发送背书请求(proposal)，节点peer0.org1接收到请求后会验证交易格式、签名和权限、尚未提交过背书proposal(重放攻击保护)。然后针对peer0.org1当前的世界状态模拟执行交易，产生响应值和读写集。</p>
<p>客户端收到背书响应和读写集后验证peer的签名，并检查是否满足了背书策略（客户端行为可以自定义，但是交易流程中的验证阶段也会进行检查），然后将其提交给orderer，如果proposal仅是查询账本，那么到这一步后将不会再提交给orderer上链，直接返回peer0.org1的查询结果。</p>
<p>排序服务中不需要检查任何交易，仅仅是各个排序节点达成共识将交易排好序后打包成块，然后分发给通道内各个组织的(leader)节点，leader节点将块再广播给其他节点验证。</p>
<p>验证过程中节点验证块内的交易以确保背书策略满足，并确保读集在模拟交易执行时生成以来，读集变量的账本状态没有变化，区块中的交易被标记为有效或无效。然后区块将被写入数据库，并更新状态。</p>
<p>在0x02测试中，产生这种安全漏洞的原因主要在于背书策略的不完善，容错性很差，在仅有一个恶意节点时就可能产生所有节点账本被修改的后果，Fabric的机制让其安全性依赖于背书策略，包括世界状态和读写集，以及背书和验证过程。</p>
<h3 id="0x04-Hyperledger-Fabric-2-0改进"><a href="#0x04-Hyperledger-Fabric-2-0改进" class="headerlink" title="0x04 Hyperledger Fabric 2.0改进"></a>0x04 Hyperledger Fabric 2.0改进</h3><p>Fabric 2.0引入了去中心化的chaincode生命周期管理， chaincode需要获得一定数量组织成员的批准才能实例化，与1.x中的单个节点就可将chaincode实例化在通道不一样；并且chaincode的默认背书策略是通道中的大多数组织，提高了本文所述数据篡改的利用难度。</p>

                    
                        


                    
                    
                        <p>
                            <a href="/2020/12/13/hyperledgerfabric-ledger-security/#post-footer" class="postShorten-excerpt_link link" aria-label="">
                                Comentar y compartir
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/10/29/flareon5_1/" aria-label=": 2018Flare-On5 Part 1">
                            2018Flare-On5 Part 1
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-10-29T23:17:18+08:00">
	
		    29 Oct 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>开始做的时候比赛已经结束很久了，偶然看到想做做逆向的练习。</p>
<h3 id="0x01-MinesweeperChampionshipRegistration"><a href="#0x01-MinesweeperChampionshipRegistration" class="headerlink" title="0x01 MinesweeperChampionshipRegistration"></a>0x01 MinesweeperChampionshipRegistration</h3><blockquote>
<p>Welcome to the Fifth Annual Flare-On Challenge! The Minesweeper World Championship is coming soon and we found the registration app. You weren’t <em>officially</em> invited but if you can figure out what the code is you can probably get in anyway. Good luck!</p>
</blockquote>
<p>无非就是找出注册码，第一题是个jar包，使用java反编译工具jd-gui载入后可以直接看到注册码<br><img src="/image/flareon/1_1.PNG" alt=""><br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">GoldenTicket2018</span>@<span class="keyword">flare</span>-<span class="keyword">on</span>.<span class="keyword">com</span></span><br></pre></td></tr></table></figure></p>
<h3 id="0x02-UltimateMinesweeper"><a href="#0x02-UltimateMinesweeper" class="headerlink" title="0x02 UltimateMinesweeper"></a>0x02 UltimateMinesweeper</h3><blockquote>
<p>You hacked your way into the Minesweeper Championship, good job. Now its time to compete. Here is the Ultimate Minesweeper binary. Beat it, win the championship, and we’ll move you on to greater challenges.</p>
</blockquote>
<p>第二题是一个扫雷游戏，格子30x30，点错一次就弹出 FAIL!<br><img src="/image/flareon/2_1.PNG" alt=""><br>查看用PEID查看导入表，只调用了一个mscoree.dll<br><img src="/image/flareon/2_2.PNG" alt=""><br>判断是.NET程序，用dnSpy反编译。<br><img src="/image/flareon/2_3.PNG" alt=""><br>在左侧的方法列表中可以发现GetKey，可能是关键点。GetKey在SquareRevealedCallback中被调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private void SquareRevealedCallback(uint column, uint row)</span><br><span class="line">&#123;</span><br><span class="line">	if (this.MineField.BombRevealed)</span><br><span class="line">	&#123;</span><br><span class="line">		this.stopwatch.Stop();</span><br><span class="line">		Application.DoEvents();</span><br><span class="line">		Thread.Sleep(1000);</span><br><span class="line">		new FailurePopup().ShowDialog();</span><br><span class="line">		Application.Exit();</span><br><span class="line">	&#125;</span><br><span class="line">	this.RevealedCells.Add(row * MainForm.VALLOC_NODE_LIMIT + column);</span><br><span class="line">	if (this.MineField.TotalUnrevealedEmptySquares == 0)</span><br><span class="line">	&#123;</span><br><span class="line">		this.stopwatch.Stop();</span><br><span class="line">		Application.DoEvents();</span><br><span class="line">		Thread.Sleep(1000);</span><br><span class="line">		new SuccessPopup(this.GetKey(this.RevealedCells)).ShowDialog();</span><br><span class="line">		Application.Exit();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SquareRevealedCallback在方法MainForm中调用，从代码大体看来SquareRevealedCallback就是关键方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public MainForm()</span><br><span class="line">&#123;</span><br><span class="line">	this.InitializeComponent();</span><br><span class="line">	this.MineField = new MineField(MainForm.VALLOC_NODE_LIMIT);</span><br><span class="line">	this.AllocateMemory(this.MineField);</span><br><span class="line">	this.mineFieldControl.DataSource = this.MineField;</span><br><span class="line">	this.mineFieldControl.SquareRevealed += this.SquareRevealedCallback;</span><br><span class="line">	this.mineFieldControl.FirstClick += this.FirstClickCallback;</span><br><span class="line">	this.stopwatch = new Stopwatch();</span><br><span class="line">	this.FlagsRemaining = this.MineField.TotalMines;</span><br><span class="line">	this.mineFieldControl.MineFlagged += this.MineFlaggedCallback;</span><br><span class="line">	this.RevealedCells = new List&lt;uint&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SquareRevealedCallback的两个参数名为column和row，字面意思理解应该就是当前点击的扫雷界面的位置（列，行）。代码第三行条件判断this.MineField.BombRevealed，BombRevealed根据名字应该与炸弹有关。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public bool BombRevealed</span><br><span class="line">&#123;</span><br><span class="line">	get</span><br><span class="line">	&#123;</span><br><span class="line">		int num = 0;</span><br><span class="line">		while ((long)num &lt; (long)((ulong)this.Size))</span><br><span class="line">		&#123;</span><br><span class="line">			int num2 = 0;</span><br><span class="line">			while ((long)num2 &lt; (long)((ulong)this.Size))</span><br><span class="line">			&#123;</span><br><span class="line">				if (this.MinesPresent[num2, num] &amp;&amp; this.MinesVisible[num2, num])</span><br><span class="line">				&#123;</span><br><span class="line">					return true;</span><br><span class="line">				&#125;</span><br><span class="line">				num2++;</span><br><span class="line">			&#125;</span><br><span class="line">			num++;</span><br><span class="line">		&#125;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码遍历扫雷的格子，如果MinesPresent和MinesVisible的值同时为1，那么this.MineField.BombRevealed值就会是1，再 通过SquareRevealedCallback中，如果第一个条件判断成立，会调用FailurePopup().ShowDialog()，即Fail的窗口，那么this.MineField.BombRevealed的值显而易见的是代表当前点中的格子是不是炸弹，是为1 不是为0(bool)，在满足this.MineField.TotalUnrevealedEmptySquares == 0后，成功的窗口有个参数this.GetKey(this.RevealedCells)，应该就是计算最终Key的。那么可不可以修改程序投机取巧一下呢，试了一下，单纯的改变条件判断流程是不行的，会产生异常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.RevealedCells.Add(row * MainForm.VALLOC_NODE_LIMIT + column);</span><br></pre></td></tr></table></figure></p>
<p>RevealCells的数据类型是List<uint>,添加元素row*MainForm.VALLOC_NODE_LIMIT+column<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static uint VALLOC_NODE_LIMIT = 30u;</span><br></pre></td></tr></table></figure></uint></p>
<p>所以RevealedCells的元素是row*30+column<br><br>然后是this.MineField.TotalUnrevealedEmptySquares == 0的判断，TotalUnrevealedEmptySquares字面意思：未显露的空方块总数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public int TotalUnrevealedEmptySquares</span><br><span class="line">&#123;</span><br><span class="line">	get</span><br><span class="line">	&#123;</span><br><span class="line">		int num = 0;</span><br><span class="line">		int num2 = 0;</span><br><span class="line">		while ((long)num2 &lt; (long)((ulong)this.Size))</span><br><span class="line">		&#123;</span><br><span class="line">			int num3 = 0;</span><br><span class="line">			while ((long)num3 &lt; (long)((ulong)this.Size))</span><br><span class="line">			&#123;</span><br><span class="line">				if (!this.MinesPresent[num2, num3] &amp;&amp; !this.MinesVisible[num2, num3])</span><br><span class="line">				&#123;</span><br><span class="line">					num++;</span><br><span class="line">				&#125;</span><br><span class="line">				num3++;</span><br><span class="line">			&#125;</span><br><span class="line">			num2++;</span><br><span class="line">		&#125;</span><br><span class="line">		return num;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>和上面格子是否代表炸弹用的同样两个值，MinesPresent和MinesPresent，num2,num3定位，多了一个num用来计数。要理解MinesPresent和MinesPresent可能要看看前面初始化时候的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public MineField(uint size)</span><br><span class="line">&#123;</span><br><span class="line">	this.Size = size;</span><br><span class="line">	this.MinesPresent = new bool[(int)size, (int)size];</span><br><span class="line">	this.MinesVisible = new bool[(int)size, (int)size];</span><br><span class="line">	this.MinesFlagged = new bool[(int)size, (int)size];</span><br><span class="line">&#125;</span><br><span class="line">// Token: 0x04000015 RID: 21</span><br><span class="line">private bool[,] minesPresent;</span><br><span class="line">// Token: 0x04000016 RID: 22</span><br><span class="line">private bool[,] minesVisible;</span><br><span class="line">// Token: 0x04000017 RID: 23</span><br><span class="line">private bool[,] minesFlagged;</span><br><span class="line">// Token: 0x04000018 RID: 24</span><br><span class="line">private uint size;</span><br></pre></td></tr></table></figure></p>
<p>三个二维数组，元素由bool组成，<br>在AllocateMemory方法中有对minesPresent的初始化<br><img src="/image/flareon/2_4.PNG" alt=""><br>其中mf.GarbageCollect[(int)num2, (int)num] = flag即为对minesPresent的赋值<br><img src="/image/flareon/2_5.PNG" alt=""><br>当DeriveVallocType的返回值包含在VALLOC_TYPES时，flag=false，VALLOC_TYPES的值如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static uint VALLOC_TYPE_HEADER_PAGE = 4294966400u;</span><br><span class="line">// Token: 0x04000008 RID: 8</span><br><span class="line">private static uint VALLOC_TYPE_HEADER_POOL = 4294966657u;</span><br><span class="line">// Token: 0x04000009 RID: 9</span><br><span class="line">private static uint VALLOC_TYPE_HEADER_RESERVED = 4294967026u;</span><br></pre></td></tr></table></figure></p>
<p>写了一个脚本来辅助，结果是当r,c为(29,25),(21,8),(8,29)时，minesPresent的值为0，很大可能为0的位置就是没有炸弹的地方了，依次在界面点击<br><img src="/image/flareon/2_6.PNG" alt=""><br>You have won the xxx,and nobody cares<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Ch3aters_Alw4ys_W1n</span>@<span class="keyword">flare</span>-<span class="keyword">on</span>.<span class="keyword">com</span></span><br></pre></td></tr></table></figure></p>
<p>前面的逻辑分析有点混乱，因为不知道minesPresent就是正确值，所以直接看AllocateMemory初始化的过程就行了，后面的流程都不用看。</p>
<h3 id="0x03-FLEGGO"><a href="#0x03-FLEGGO" class="headerlink" title="0x03 FLEGGO"></a>0x03 FLEGGO</h3><blockquote>
<p>When you are finished with your media interviews and talk show appearances after that crushing victory at the Minesweeper Championship, I have another task for you. Nothing too serious, as you’ll see, this one is child’s play.</p>
</blockquote>
<p><img src="/image/flareon/3_1.PNG" alt=""><br>child’s play？<br><br>48个文件，应该都是crakeme，要求输入password<br><br>第一个文件1BpnGjHOT7h5vvZsV4vISSb60Xj3pX5G.exe，会有两个比较<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IronManSucks</span><br><span class="line">ZImIT7DyCMOeF6</span><br></pre></td></tr></table></figure></p>
<p>输入第一个password什么都没有，第二个会在同目录生成一个图片。并且控制台会输出一个字符<br><img src="/image/flareon/3_2.PNG" alt=""><br>48个password全部输入成功，就会有48个字符。并且48张图是按照乐高的顺序排列的，就可以将48个字符排序，直接手动一个一个的分析password再输入得到结果再排序肯定是可以的，但这里是48个文件，如果是480个那得搬到哪天去~，so 接下来就分析一下这些文件的共通性。<br><img src="/image/flareon/compare.PNG" alt=""><br>使用UltraCompare比较两个文件，可以看到前面的完全一致，差异性从偏移0x2ab0开始，另外比较了几个文件，差异都从0x2ab0开始，通过stu_PE查看PE结构可以知道这一段是资源段。<br><img src="/image/flareon/3_3.PNG" alt=""><br>用x32dbg调试，程序通过FindResource获取资源名为”BRICK”的资源句柄。LoadResource得到password，并且最后输出的字符都在特定的偏移位置（图片名和字符通过异或加密），写了一个程序来读取每个程序的图片名和字符，没想到好的方法来读取图片的顺序并自动化，所以最后一步只有通过手动。<br>首先，读取资源段的C代码如下（选择用C写的原因是因为FindResource直接就可以读了，很方便）<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;winuser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HGLOBAL hResLoad;</span><br><span class="line">HMODULE hExe;</span><br><span class="line">HRSRC hRes;</span><br><span class="line"><span class="keyword">char</span> *p;</span><br><span class="line"><span class="keyword">char</span> *password, key, *filename;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j, k, len_password;</span><br><span class="line">    <span class="keyword">if</span>(argc == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        hExe = LoadLibrary(TEXT(argv[<span class="number">1</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(argc == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        hExe = LoadLibrary(TEXT(argv[<span class="number">2</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Please input argument.\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(hExe == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't load exe.\n"</span>);</span><br><span class="line">        system(<span class="string">"pause"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    hRes = FindResourceW(hExe,<span class="number">101</span>,<span class="string">L"BRICK"</span>);</span><br><span class="line">    <span class="comment">//printf("%d\n",GetLastError());</span></span><br><span class="line">    <span class="keyword">if</span>(hRes == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"FindResource failed.\n"</span>);</span><br><span class="line">        system(<span class="string">"pause"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    hResLoad = LoadResource(hExe,hRes);</span><br><span class="line">    <span class="keyword">if</span>(hResLoad == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"LoadResource failed\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,GetLastError());</span><br><span class="line">    &#125;</span><br><span class="line">    p = hResLoad;</span><br><span class="line">    password = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">20</span>);</span><br><span class="line">    filename = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>, j = <span class="number">0</span>; *(p + i) != <span class="number">0</span>; i += <span class="number">2</span>, j++)</span><br><span class="line">    &#123;</span><br><span class="line">        *( password + j ) = *( p + i );</span><br><span class="line">    &#125;</span><br><span class="line">    len_password = j;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">32</span>, j = <span class="number">0</span>; i &lt; <span class="number">55</span>; i += <span class="number">2</span>, j++)</span><br><span class="line">    &#123;</span><br><span class="line">        * ( filename + j) = *( p + i ) ^ <span class="number">0x85</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    k = j;</span><br><span class="line">    <span class="keyword">if</span>(argc == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; k; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,*(filename+j));</span><br><span class="line">        &#125;</span><br><span class="line">        key = *( p + <span class="number">64</span> ) ^ <span class="number">0x1A</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">",%c\n"</span>,key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(argc == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; len_password; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,*(password + j));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!FreeLibrary(hExe))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Could not free executable."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//system("pause");</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这段代码有几个功能：</p>
<ol>
<li>读取资源段</li>
<li>按照传入参数的不同选择输出password或者图片名+字符(key)</li>
</ol>
<p>然后用python来实现遍历文件夹以及执行命令的功能，因为python遍历文件夹比C方便<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">path = <span class="string">"E:\\work\\Flare-On5\\Flare-On5_Challenges\\FlareOn5_Challenges\\03_FLEGGO"</span></span><br><span class="line">files = os.listdir(path)</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">    <span class="keyword">if</span> os.path.splitext(f)[<span class="number">-1</span>] == <span class="string">'.exe'</span>:</span><br><span class="line">        filename = os.path.join(path,f)</span><br><span class="line">        <span class="comment">#os.system('test.exe %s'%filename)</span></span><br><span class="line">        os.system(<span class="string">'test.exe -whatever %s | %s'</span>%(filename,filename))</span><br></pre></td></tr></table></figure></p>
<p>执行完毕后图片已经全部生成，并且key已经打印出来，但是要点开48张图片给字符排序也是一种重复劳动，如果要做图像的识别又感觉有点超纲了。。暂时没别的办法我只能手动了<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mor3_awes0m3_th4n_an_awes0em_p0ssum</span>@<span class="keyword">flare</span>-<span class="keyword">on</span>.<span class="keyword">com</span></span><br></pre></td></tr></table></figure></p>
<p>弄完之后看了官方给的解答，才发现读取资源段的时候忽略了一个重要的值<br><img src="/image/flareon/3_4.PNG" alt=""><br>这是图片序号为7的程序的内存<br><img src="/image/flareon/3_5.PNG" alt=""><br>这是序号为35(0x23)的图片的位置。既然序号能读出来，那自动化排序也不是难事。</p>
<blockquote>
<p>Part1就这些，后续的慢慢做，毕竟还要上班，还要看书。。</p>
</blockquote>

                    
                        


                    
                    
                        <p>
                            <a href="/2018/10/29/flareon5_1/#post-footer" class="postShorten-excerpt_link link" aria-label="">
                                Comentar y compartir
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/10/20/hawkeye-vbinject/" aria-label=": 负载恶意软件Hawkeye的VB Inject样本分析">
                            负载恶意软件Hawkeye的VB Inject样本分析
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-10-20T22:56:18+08:00">
	
		    20 Oct 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>这篇文章已投稿于freebuf<br><br><a href="http://www.freebuf.com/articles/paper/186050.html" target="_blank" rel="noopener">freebuf链接</a></p>

                    
                        


                    
                    
                        <p>
                            <a href="/2018/10/20/hawkeye-vbinject/#post-footer" class="postShorten-excerpt_link link" aria-label="">
                                Comentar y compartir
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-right">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/06/10/2017-pediy-ctf-2/" aria-label=": 2017看雪CTF leifeiCM">
                            2017看雪CTF leifeiCM
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-06-10T22:16:01+08:00">
	
		    10 Jun 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-excerpt">
                    <p>这个CM无壳，就是算法比较绕人，用OD载入之后输入987654321测试<br>
                    
                        <a href="/2017/06/10/2017-pediy-ctf-2/" class="postShorten-excerpt_link link" aria-label=": 2017看雪CTF leifeiCM">
                            Seguir leyendo
                        </a>
                        
                    
                </p></div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/05/25/2017-iscc-reverse/" aria-label=": 2017 ISCC Reverse Writeup">
                            2017 ISCC Reverse Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-05-25T22:13:36+08:00">
	
		    25 May 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p><a href="http://www.52pojie.cn/thread-611256-1-1.html" target="_blank" rel="noopener">帖子地址</a></p>

                    
                        


                    
                    
                        <p>
                            <a href="/2017/05/25/2017-iscc-reverse/#post-footer" class="postShorten-excerpt_link link" aria-label="">
                                Comentar y compartir
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-right">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/05/15/hook-api-2/" aria-label=": API HOOK(2)">
                            API HOOK(2)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-05-15T22:03:45+08:00">
	
		    15 May 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-excerpt">
                    <h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>接着上一篇的dll注入写，现在是来写API HOOK的主要代码。<br>
                    
                        <a href="/2017/05/15/hook-api-2/" class="postShorten-excerpt_link link" aria-label=": API HOOK(2)">
                            Seguir leyendo
                        </a>
                        
                    
                </p></div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-right">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/05/15/hook-api-1/" aria-label=": API HOOK(1)">
                            API HOOK(1)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-05-15T21:53:24+08:00">
	
		    15 May 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-excerpt">
                    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>还是windows核心编程的期末答辩，上次那个键盘记录器只完成了一部分，这次要实现的是采用HOOK API技术，<br>拦截记事本的保存操作，
                    
                        <a href="/2017/05/15/hook-api-1/" class="postShorten-excerpt_link link" aria-label=": API HOOK(1)">
                            Seguir leyendo
                        </a>
                        
                    
                </p></div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-right">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/05/13/keyboard-logger/" aria-label=": 键盘记录器">
                            键盘记录器
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-05-13T21:49:54+08:00">
	
		    13 May 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-excerpt">
                    <h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>Windows核心编程的期末答辩<br>
                    
                        <a href="/2017/05/13/keyboard-logger/" class="postShorten-excerpt_link link" aria-label=": 键盘记录器">
                            Seguir leyendo
                        </a>
                        
                    
                </p></div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-right">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/05/10/2016-Tencent-01/" aria-label=": 2016腾讯游戏安全第一题">
                            2016腾讯游戏安全第一题
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-05-10T21:39:54+08:00">
	
		    10 May 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-excerpt">
                    <h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>这个题去年腾讯游戏安全挑战赛的时候做过，没有做粗来，一直留在我的电脑里，前几天逛看雪的时候看到一个分析贴，才想着把它做了。<br>
                    
                        <a href="/2017/05/10/2016-Tencent-01/" class="postShorten-excerpt_link link" aria-label=": 2016腾讯游戏安全第一题">
                            Seguir leyendo
                        </a>
                        
                    
                </p></div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">página 1 de 1</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 h0rs3fa11. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">h0rs3fa11</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-xlumxrnrjzzbfjca3ypp7aj0nlwsczvjtptgkhweiricesxapx8i1mnl0k6u.min.js"></script>
<!--SCRIPTS END-->





    </body>
</html>
